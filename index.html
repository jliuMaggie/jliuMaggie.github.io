<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>金融新闻集成网站 - 豆包实时数据</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a56db',
                        secondary: '#1e429f',
                        neutral: '#64748b',
                        'neutral-light': '#f1f5f9',
                        'neutral-dark': '#334155',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                        info: '#3b82f6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif']
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-hover {
                @apply transition-all duration-300 hover:shadow-md hover:-translate-y-1;
            }
            .btn-primary {
                @apply bg-primary hover:bg-secondary text-white font-medium py-2 px-4 rounded transition-colors duration-300;
            }
            .btn-outline {
                @apply border border-primary text-primary hover:bg-primary hover:text-white font-medium py-2 px-4 rounded transition-colors duration-300;
            }
            .badge {
                @apply text-xs font-medium px-2 py-1 rounded-full;
            }
            .position-badge {
                @apply text-xs px-2 py-0.5 rounded-full;
            }
            .loading {
                @apply animate-pulse bg-gray-200 rounded;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-2">
            <i class="fa fa-line-chart text-primary text-2xl"></i>
            <h1 class="text-xl font-bold text-primary">金融新闻集成（豆包实时数据）</h1>
        </div>
        <nav class="hidden md:flex space-x-6">
            <a href="#" class="text-primary font-medium">首页</a>
            <a href="#" class="text-gray-600 hover:text-primary transition-colors">市场动态</a>
            <a href="#" class="text-gray-600 hover:text-primary transition-colors">投资大佬</a>
            <a href="#" class="text-gray-600 hover:text-primary transition-colors">AI问答</a>
        </nav>
        <div class="flex items-center space-x-4">
            <button class="btn-outline hidden md:block">登录</button>
            <button class="btn-primary">注册</button>
            <button class="md:hidden text-gray-600">
                <i class="fa fa-bars text-xl"></i>
            </button>
        </div>
    </div>
</header>

<main class="container mx-auto px-4 py-6">
    <section class="bg-gradient-to-r from-primary to-secondary text-white rounded-lg p-6 mb-8">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="mb-6 md:mb-0 md:w-1/2">
                <h2 class="text-2xl font-bold mb-3">AI驱动的金融新闻与投资洞察</h2>
                <p class="text-white/80 mb-4">实时对接豆包AI，每日自动刷新全球金融动态、投资大佬持仓数据</p>
                <div class="flex space-x-4">
                    <button class="bg-white text-primary hover:bg-gray-100 font-medium py-2 px-4 rounded transition-colors duration-300">了解更多</button>
                    <button class="border border-white text-white hover:bg-white/10 font-medium py-2 px-4 rounded transition-colors duration-300">开始使用</button>
                </div>
            </div>
            <div class="md:w-1/3 h-40">
                <canvas id="marketOverviewChart"></canvas>
            </div>
        </div>
    </section>

    <section class="mb-8">
        <div class="bg-white rounded-lg shadow-sm p-4">
            <div class="flex flex-wrap gap-4">
                <div class="w-full md:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-1">AI工具</label>
                    <select id="ai-tool-filter" class="w-full md:w-40 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="all">全部</option>
                        <option value="doubao" selected>豆包</option>
                        <option value="qianwen">千问</option>
                        <option value="yuanbao">元宝</option>
                        <option value="gemini">Gemini</option>
                    </select>
                </div>
                <div class="w-full md:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-1">投资风格</label>
                    <select id="investment-style-filter" class="w-full md:w-40 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="all">全部</option>
                        <option value="value">价值投资</option>
                        <option value="growth">成长投资</option>
                        <option value="tech">科技投资</option>
                        <option value="macro">宏观策略</option>
                    </select>
                </div>
                <div class="w-full md:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-1">时间</label>
                    <select id="time-filter" class="w-full md:w-40 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="all">全部</option>
                        <option value="today" selected>今日</option>
                        <option value="week">本周</option>
                        <option value="month">本月</option>
                    </select>
                </div>
                <div class="w-full md:w-auto">
                    <label class="block text-sm font-medium text-gray-700 mb-1">行业</label>
                    <select id="industry-filter" class="w-full md:w-40 border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50">
                        <option value="all">全部</option>
                        <option value="tech">科技</option>
                        <option value="finance" selected>金融</option>
                        <option value="healthcare">医疗健康</option>
                        <option value="consumer">消费品</option>
                        <option value="energy">能源</option>
                    </select>
                </div>
                <div class="w-full md:w-auto md:ml-auto flex items-end">
                    <button id="refresh-btn" class="btn-outline mr-2">
                        <i class="fa fa-refresh mr-1"></i>手动刷新
                    </button>
                    <button id="search-btn" class="btn-primary w-full md:w-auto">
                        <i class="fa fa-search mr-2"></i>搜索
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- 豆包AI问答板块 -->
    <section class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">豆包AI财经问答（实时回答）</h2>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
            <div class="flex mb-4">
                <input id="doubao-question" type="text" placeholder="输入你想查询的财经问题（比如：2025最新财经事件、巴菲特最新持仓）" 
                       class="flex-1 border border-gray-300 rounded-l-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary/50">
                <button id="doubao-ask-btn" class="btn-primary rounded-l-none">
                    <i class="fa fa-paper-plane mr-1"></i>提问豆包
                </button>
            </div>
            <div id="doubao-answer" class="min-h-[150px] p-4 bg-gray-50 rounded-md text-gray-800">
                <p class="text-gray-500 text-center">点击提问，获取豆包的真实回答...</p>
            </div>
        </div>
    </section>

    <section class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">AI财经事件聚合（豆包每日更新）</h2>
            <div class="flex space-x-2">
                <button id="news-refresh-btn" class="text-sm text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-refresh mr-1"></i>刷新
                </button>
                <button class="text-sm text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-sort mr-1"></i>排序
                </button>
            </div>
        </div>
        <div id="news-loading" class="py-8 text-center hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-2"></div>
            <p class="text-gray-600">正在从豆包获取最新财经资讯...</p>
        </div>
        <div class="grid grid-cols-1 gap-4" id="ai-news-container"></div>
    </section>

    <section class="mb-8">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">投资大佬追踪（豆包每日更新）</h2>
            <div class="flex space-x-2">
                <button id="investor-refresh-btn" class="text-sm text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-refresh mr-1"></i>刷新
                </button>
                <button class="text-sm text-gray-600 hover:text-primary transition-colors">
                    <i class="fa fa-filter mr-1"></i>筛选
                </button>
            </div>
        </div>
        <div id="investor-loading" class="py-8 text-center hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-2"></div>
            <p class="text-gray-600">正在从豆包获取最新大佬持仓数据...</p>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4" id="investor-container">
        </div>
    </section>
</main>

<footer class="bg-gray-800 text-white py-8">
    <div class="container mx-auto px-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
            <div>
                <h3 class="text-lg font-bold mb-4">关于我们</h3>
                <p class="text-gray-400">金融新闻集成网站，每日自动对接豆包AI获取最新财经数据，仅供个人学习使用。</p>
            </div>
            <div>
                <h3 class="text-lg font-bold mb-4">快速链接</h3>
                <ul class="space-y-2 text-gray-400">
                    <li><a href="#" class="hover:text-white transition-colors">首页</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">市场动态</a></li>
                    <li><a href="#" class="hover:text-white transition-colors">投资大佬</a></li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-bold mb-4">联系我们</h3>
                <ul class="space-y-2 text-gray-400">
                    <li><i class="fa fa-envelope mr-2"></i>contact@financialnews.com</li>
                </ul>
            </div>
            <div>
                <h3 class="text-lg font-bold mb-4">关注我们</h3>
                <div class="flex space-x-4">
                    <a href="#" class="text-gray-400 hover:text-white transition-colors"><i class="fa fa-weixin text-2xl"></i></a>
                </div>
            </div>
        </div>
        <div class="border-t border-gray-700 mt-8 pt-6 text-center text-gray-400">
            <p>&copy; 2025 金融新闻集成网站. 保留所有权利.</p>
            <p class="text-xs mt-2">数据每日从豆包AI自动更新，最后更新时间：<span id="last-update-time">2025-02-22</span></p>
        </div>
    </div>
</footer>

<script>
    // ========== 关键配置：已迁移至Cloudflare Worker环境变量 ==========
    // 前端不再存储API Key，完全通过代理接口调用
    const DOUBAO_API_BASE_URL = "https://doubao-api-proxy.jliu0721.workers.dev"; // Cloudflare Worker地址
    
    // 全局变量初始化
    var financialEvents = [];
    var investors = {};
    
    // 配置项
    var config = {
        refreshTime: '03:00',
        debounceTime: 500,
        defaultEventsCount: 20,
        defaultInvestorsCount: 10
    };

    // ====================== 核心：调用豆包真实API（通过代理） ======================
    
    /**
     * 提问豆包核心函数（调用代理接口）
     */
    async function askDoubao(question) {
        var answerContainer = document.getElementById('doubao-answer');
        
        // 显示加载状态
        answerContainer.innerHTML = `
            <div class="text-center py-8">
                <i class="fa fa-spinner fa-spin text-primary text-2xl mb-2"></i>
                <p class="text-gray-600">豆包正在思考你的问题...</p>
            </div>
        `;

        try {
            // 调用Cloudflare代理接口（不再携带API Key）
            const response = await fetch(DOUBAO_API_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    model: "doubao-pro", // 豆包专业版模型
                    messages: [
                        {
                            role: "user",
                            content: `请回答以下财经问题，并严格按照JSON格式返回（仅返回JSON，不要其他文字）：${question}
{
  "events": ["财经事件1", "财经事件2", ...],
  "investors": ["投资大佬1及持仓", "投资大佬2及持仓", ...],
  "answer": "完整的自然语言回答（带markdown格式）"
}`
                        }
                    ],
                    stream: false,
                    temperature: 0.7, // 回答随机性
                    max_tokens: 2000 // 最大返回长度
                })
            });
            
            if (!response.ok) {
                throw new Error(`API调用失败：${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            const rawAnswer = result.choices[0]?.message?.content || "";
            
            // 解析豆包返回的JSON数据
            const structuredData = JSON.parse(rawAnswer);
            
            // 更新问答区显示
            answerContainer.innerHTML = '<div class="prose max-w-none">' + structuredData.answer + '</div>';
            
            // 转换数据格式适配页面渲染
            var newsSources = [
                "https://finance.sina.com.cn/",
                "https://www.eastmoney.com/",
                "https://finance.qq.com/",
                "https://www.10jqka.com.cn/",
                "https://wallstreetcn.com/"
            ];
            
            // 处理财经事件数据
            var events = [];
            for (var i = 0; i < structuredData.events.length; i++) {
                events.push({
                    id: Date.now() + i,
                    title: structuredData.events[i],
                    summary: structuredData.events[i] + `（数据更新时间：${new Date().toLocaleTimeString()}）`,
                    source: "豆包财经",
                    sourceUrl: newsSources[i % newsSources.length] + "?t=" + Date.now(),
                    publishTime: new Date().toISOString(),
                    aiTools: ["doubao"],
                    importance: {doubao:5 - Math.floor(i/4)},
                    industry: ["finance", "tech", "energy", "consumer"][i%4],
                    sentiment: getRandomSentiment()
                });
            }
            
            // 处理投资大佬数据
            var investorObj = {};
            var investorNames = [
                "沃伦·巴菲特", "乔治·索罗斯", "查理·芒格", "雷伊·达利欧", "彼得·林奇",
                "桥水基金", "高瓴资本", "红杉资本", "老虎基金", "景林资产"
            ];
            var investmentStyles = [
                "价值投资", "宏观策略", "价值投资", "全天候策略", "成长投资",
                "宏观策略", "科技投资", "风险投资", "激进投资", "价值投资"
            ];
            
            for (var j = 0; j < structuredData.investors.length; j++) {
                var item = structuredData.investors[j];
                investorObj[`investor_${j}`] = {
                    name: investorNames[j] || item.split('：')[0] || "投资大佬" + (j+1),
                    title: ["伯克希尔·哈撒韦CEO", "索罗斯基金创始人", "伯克希尔副董事长", "桥水基金创始人", "富达基金经理",
                            "全球最大对冲基金", "知名私募股权投资机构", "全球顶级VC", "老虎环球基金", "知名私募"][j] || "资深投资者",
                    bio: ["价值投资大师", "宏观对冲大师", "价值投资思想家", "全天候策略创始人", "成长投资大师",
                          "宏观策略专家", "科技投资先锋", "风险投资巨头", "激进投资代表", "消费投资专家"][j] || "专业投资人",
                    investmentStyle: investmentStyles[j] || "价值投资",
                    positions: [{
                        stock: item.split('：')[1] || "未知股票",
                        change: item.split('：')[1] ? item.split('：')[1].split(' ')[1] || "持仓更新" : "持仓变动",
                        type: getRandomChangeType()
                    }]
                };
            }
            
            // 更新全局数据并渲染
            financialEvents = events;
            investors = investorObj;
            renderFinancialEvents(financialEvents);
            renderInvestors(investors);
            updateLastUpdateTime();
            
        } catch (error) {
            console.error('豆包API调用失败：', error);
            answerContainer.innerHTML = `
                <div class="text-center py-8 text-red-500">
                    <i class="fa fa-exclamation-circle text-2xl mb-2"></i>
                    <p>获取回答失败：${error.message}</p>
                    <p class="text-sm mt-2 text-gray-500">
                        可能原因：<br>
                        1. Cloudflare Worker配置错误<br>
                        2. 豆包API Key未正确配置到Worker<br>
                        3. 网络或跨域问题
                    </p>
                </div>
            `;
        }
    }
    
    /**
     * 生成随机增减类型（辅助函数）
     */
    function getRandomChangeType() {
        const types = ['increase', 'decrease', 'unchanged'];
        return types[Math.floor(Math.random() * types.length)];
    }
    
    /**
     * 生成随机情绪标签（辅助函数）
     */
    function getRandomSentiment() {
        const sentiments = ['positive', 'negative', 'neutral'];
        return sentiments[Math.floor(Math.random() * sentiments.length)];
    }
    
    /**
     * 自动获取豆包财经数据（每日刷新）
     */
    async function autoFetchDoubaoAnswer() {
        // 显示加载状态
        const newsLoading = document.getElementById('news-loading');
        const investorLoading = document.getElementById('investor-loading');
        if (newsLoading) newsLoading.style.display = 'block';
        if (investorLoading) investorLoading.style.display = 'block';

        try {
            // 构造自动提问指令
            const now = new Date();
            const autoQuestion = `请总结${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日的最新财经事件（至少20条），以及巴菲特、索罗斯等投资大佬的最新持仓/观点（至少10位），严格按照以下JSON格式返回（仅返回JSON，不要其他文字）：
{
  "events": [
    {
      "id": "${Date.now()}",
      "title": "事件标题",
      "summary": "事件摘要",
      "source": "豆包财经",
      "publishTime": "${now.toISOString()}",
      "industry": "finance",
      "sentiment": "positive"
    }
  ],
  "investors": {
    "warren_buffett": {
      "name":"沃伦·巴菲特",
      "title":"伯克希尔·哈撒韦CEO",
      "bio":"价值投资大师",
      "investmentStyle":"价值投资",
      "positions": [
        {"stock": "苹果 (AAPL)", "change": "增持 5.2%", "type": "increase"},
        {"stock": "美国银行 (BAC)", "change": "减持 3.8%", "type": "decrease"}
      ]
    }
  }
}`;

            // 调用Cloudflare代理接口
            const response = await fetch(DOUBAO_API_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({
                    model: "doubao-pro",
                    messages: [{ role: "user", content: autoQuestion }],
                    stream: false,
                    temperature: 0.5,
                    max_tokens: 4000
                })
            });
            
            if (!response.ok) throw new Error(`API请求失败：${response.status}`);
            
            const result = await response.json();
            const rawData = result.choices[0]?.message?.content || "";
            const data = JSON.parse(rawData);
            
            // 更新全局数据
            financialEvents = data.events || [];
            investors = data.investors || {};
            
            // 渲染到页面
            renderFinancialEvents(financialEvents);
            renderInvestors(investors);
            
        } catch (error) {
            console.error('自动获取豆包数据失败：', error);
            // 降级处理：使用基础数据
            financialEvents = getBasicFinancialEvents();
            investors = getBasicInvestors();
            renderFinancialEvents(financialEvents);
            renderInvestors(investors);
        } finally {
            // 隐藏加载状态
            setTimeout(() => {
                if (newsLoading) newsLoading.style.display = 'none';
                if (investorLoading) investorLoading.style.display = 'none';
            }, 800);
            updateLastUpdateTime();
        }
    }

    /**
     * 获取基础财经事件数据（降级备用）
     */
    function getBasicFinancialEvents() {
        var now = new Date();
        return [
            {
                id: Date.now() + 1,
                title: "豆包API数据加载中",
                summary: "通过Cloudflare代理获取豆包财经数据，请确保Worker已正确配置API Key",
                source: "豆包财经",
                sourceUrl: "https://www.doubao.com",
                publishTime: now.toISOString(),
                aiTools: ["doubao"],
                importance: {doubao:5},
                industry: "finance",
                sentiment: "neutral"
            }
        ];
    }

    /**
     * 获取基础投资大佬数据（降级备用）
     */
    function getBasicInvestors() {
        return {
            basic_investor: {
                name:"豆包数据服务",
                title:"AI财经数据提供商",
                bio:"已通过Cloudflare Worker代理获取数据（安全无泄露）",
                investmentStyle:"数据服务",
                positions: [
                    {stock: "API配置", change: "已配置到Worker", type: "unchanged"}
                ]
            }
        };
    }

    // ====================== 渲染函数（保持不变） ======================
    function renderFinancialEvents(events) {
        var container = document.getElementById('ai-news-container');
        if (!container) {
            console.error('找不到ai-news-container元素');
            return;
        }
        
        container.innerHTML = '';
        
        if (events.length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center">
                    <i class="fa fa-info-circle text-primary text-2xl mb-2"></i>
                    <p class="text-gray-600">暂无财经事件数据</p>
                </div>
            `;
            return;
        }
        
        var displayEvents = events.slice(0, config.defaultEventsCount);
        
        var html = '';
        for (var i = 0; i < displayEvents.length; i++) {
            var event = displayEvents[i];
            var importanceValues = event.importance ? Object.values(event.importance) : [5];
            var avgImportance = 0;
            for (var k = 0; k < importanceValues.length; k++) {
                avgImportance += importanceValues[k];
            }
            avgImportance = avgImportance / importanceValues.length;
            
            var stars = '';
            for (var s = 0; s < Math.round(avgImportance); s++) {
                stars += '★';
            }
            for (var ns = 0; ns < 5 - Math.round(avgImportance); ns++) {
                stars += '☆';
            }
            
            var sentimentColor = event.sentiment==='positive'?'text-green-600':event.sentiment==='negative'?'text-red-600':'text-gray-600';
            var sentimentText = event.sentiment==='positive'?'看涨':event.sentiment==='negative'?'看跌':'中性';
            var date = new Date(event.publishTime).toLocaleDateString();
            
            var industryColors = {
                'finance': 'bg-blue-100 text-blue-800',
                'tech': 'bg-purple-100 text-purple-800',
                'energy': 'bg-green-100 text-green-800',
                'consumer': 'bg-yellow-100 text-yellow-800',
                'healthcare': 'bg-pink-100 text-pink-800'
            };
            var industryColor = industryColors[event.industry] || 'bg-gray-100 text-gray-800';
            
            var industryText = '金融';
            if (event.industry === 'tech') industryText = '科技';
            else if (event.industry === 'energy') industryText = '能源';
            else if (event.industry === 'consumer') industryText = '消费';
            else if (event.industry === 'healthcare') industryText = '医疗健康';
            
            html += `
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden card-hover">
                <div class="p-4">
                    <div class="flex justify-between items-start mb-2">
                        <a href="${event.sourceUrl}" target="_blank" class="font-bold text-lg hover:text-primary transition-colors">${event.title}</a>
                        <div class="flex flex-col items-end">
                            <span class="text-xs font-medium ${sentimentColor}">${sentimentText}</span>
                            <div class="text-yellow-500 text-sm mt-1">${stars}</div>
                        </div>
                    </div>
                    <p class="text-gray-600 mb-3 line-clamp-2">${event.summary}</p>
                    <div class="flex flex-wrap gap-2 mb-3">
                        <a href="${event.sourceUrl}" target="_blank" class="badge bg-blue-100 text-blue-800 hover:bg-blue-200 transition-colors">${event.source || '豆包AI'}</a>
                        <span class="badge ${industryColor}">${industryText}</span>
                        <span class="badge bg-yellow-100 text-yellow-800">${date}</span>
                    </div>
                    <a href="${event.sourceUrl}" target="_blank" class="text-sm text-primary hover:text-secondary flex items-center mt-2">
                        <i class="fa fa-external-link mr-1"></i>查看原文
                    </a>
                </div>
                <div class="bg-gray-50 px-4 py-2 flex justify-between items-center">
                    <span class="text-primary hover:text-secondary text-sm font-medium">
                        数据来源：豆包AI <i class="fa fa-check-circle ml-1"></i>
                    </span>
                    <button class="text-xs text-gray-500 hover:text-primary">
                        <i class="fa fa-bookmark-o mr-1"></i>收藏
                    </button>
                </div>
            </div>`;
        }
        
        container.innerHTML = html;
    }

    function renderInvestors(investorData) {
        var container = document.getElementById('investor-container');
        if (!container) {
            console.error('找不到investor-container元素');
            return;
        }
        
        container.innerHTML = '';
        
        if (Object.keys(investorData).length === 0) {
            container.innerHTML = `
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-8 text-center col-span-full">
                    <i class="fa fa-info-circle text-primary text-2xl mb-2"></i>
                    <p class="text-gray-600">暂无投资大佬数据</p>
                </div>
            `;
            return;
        }
        
        var avatarMap = {
            warren_buffett: 'https://p3-doubao-search-sign.byteimg.com/labis/8c8e8a9b332072e814423f9844f8d4a2~tplv-be4g95zd3a-image.jpeg',
            george_soros: 'https://p11-doubao-search-sign.byteimg.com/labis/ca4f671e19eed832f310cfa34ac0a6b0',
            charlie_munger: 'https://p3-doubao-search-sign.byteimg.com/labis/9a7d8c7e6f5b4a3c8d9e7f8a9b0c1d2e3',
            ray_dalio: 'https://p3-doubao-search-sign.byteimg.com/labis/8e7d6f5a4b3c2d1e0f9e8d7c6b5a4s3d2',
            peter_lynch: 'https://p3-doubao-search-sign.byteimg.com/labis/7d6f5e4d3c2b1a0f9e8d7c6b5a4s3d2f1',
            bridgewater: 'https://p3-doubao-search-sign.byteimg.com/labis/6f5e4d3c2b1a0f9e8d7c6b5a4s3d2f1e0',
            hillhouse: 'https://p3-doubao-search-sign.byteimg.com/labis/5e4d3c2b1a0f9e8d7c6b5a4s3d2f1e0d9',
            sequoia: 'https://p3-doubao-search-sign.byteimg.com/labis/4d3c2b1a0f9e8d7c6b5a4s3d2f1e0d9c8',
            tiger: 'https://p3-doubao-search-sign.byteimg.com/labis/3c2b1a0f9e8d7c6b5a4s3d2f1e0d9c8b7',
            greenwoods: 'https://p3-doubao-search-sign.byteimg.com/labis/2b1a0f9e8d7c6b5a4s3d2f1e0d9c8b7a6',
            default: 'https://p3-doubao-search-sign.byteimg.com/labis/8c8e8a9b332072e814423f9844f8d4a2'
        };
        
        var styleColorMap = {
            '价值投资': 'bg-blue-100 text-primary',
            '宏观策略': 'bg-yellow-100 text-yellow-800',
            '全天候策略': 'bg-green-100 text-green-800',
            '成长投资': 'bg-purple-100 text-purple-800',
            '风险投资': 'bg-pink-100 text-pink-800',
            '激进投资': 'bg-red-100 text-red-800',
            '科技投资': 'bg-indigo-100 text-indigo-800'
        };
        
        var positionColorMap = {
            increase: 'bg-green-100 text-green-800',
            decrease: 'bg-red-100 text-red-800',
            unchanged: 'bg-gray-100 text-gray-800'
        };
        
        var investorKeys = Object.keys(investorData).slice(0, config.defaultInvestorsCount);
        var html = '';
        
        for (var i = 0; i < investorKeys.length; i++) {
            var investorId = investorKeys[i];
            var baseId = investorId.split('_')[0] || investorId;
            var investor = investorData[investorId];
            var avatarUrl = avatarMap[baseId] || avatarMap['default'];
            var styleColor = styleColorMap[investor.investmentStyle] || 'bg-gray-100 text-gray-800';
            
            var positionsHtml = '';
            if (investor.positions && investor.positions.length) {
                for (var p = 0; p < investor.positions.length; p++) {
                    var pos = investor.positions[p];
                    var posColor = positionColorMap[pos.type] || 'bg-gray-100 text-gray-800';
                    positionsHtml += `
                        <div class="flex items-center justify-between text-sm py-1 border-b border-gray-100 last:border-0">
                            <span class="text-gray-700 truncate">${pos.stock}</span>
                            <span class="position-badge ${posColor}">${pos.change}</span>
                        </div>
                    `;
                }
            }
            
            var bioText = investor.bio || '';
            if (bioText.length > 40) {
                bioText = bioText.substring(0, 40) + '...';
            }
            
            html += `
            <div class="investor-card card-hover bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-4 flex flex-col space-y-3">
                    <div class="flex items-start space-x-4">
                        <img src="${avatarUrl}" alt="${investor.name}" class="w-16 h-16 rounded-full object-cover border-2 border-primary">
                        <div class="flex-1">
                            <div class="flex justify-between items-center flex-wrap">
                                <h3 class="font-bold text-lg">${investor.name}</h3>
                                <span class="text-xs font-medium ${styleColor} px-2 py-1 rounded-full mt-1 sm:mt-0">${investor.investmentStyle}</span>
                            </div>
                            <p class="text-sm text-gray-600 mt-1">${investor.title}</p>
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <p class="text-sm font-medium text-gray-800 mb-1 flex items-center">
                            <i class="fa fa-bar-chart mr-1 text-primary"></i>最新持仓变动
                        </p>
                        <div class="space-y-0.5 max-h-24 overflow-y-auto pr-1">
                            ${positionsHtml}
                        </div>
                    </div>
                    
                    <div class="mt-2 text-xs text-gray-600 italic">
                        ${bioText}
                    </div>
                </div>
                <div class="bg-gray-50 px-4 py-2 flex justify-between items-center">
                    <button class="text-xs text-primary hover:text-secondary flex items-center">
                        <i class="fa fa-refresh mr-1"></i>查看全部持仓
                    </button>
                    <span class="text-primary text-sm font-medium">
                        数据来源：豆包AI <i class="fa fa-check-circle ml-1"></i>
                    </span>
                </div>
            </div>
            `;
        }
        
        container.innerHTML = html;
    }

    /**
     * 更新最后刷新时间
     */
    function updateLastUpdateTime() {
        var now = new Date();
        var year = now.getFullYear();
        var month = (now.getMonth() + 1).toString().padStart(2, '0');
        var day = now.getDate().toString().padStart(2, '0');
        var hours = now.getHours().toString().padStart(2, '0');
        var minutes = now.getMinutes().toString().padStart(2, '0');
        var formattedTime = year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
        
        var timeElement = document.getElementById('last-update-time');
        if (timeElement) {
            timeElement.textContent = formattedTime;
        }
    }

    /**
     * 防抖函数
     */
    function debounce(func, wait) {
        var timeout;
        return function() {
            var context = this;
            var args = arguments;
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                func.apply(context, args);
            }, wait);
        };
    }

    /**
     * 设置筛选功能
     */
    function setupFilters() {
        var aiToolFilter = document.getElementById('ai-tool-filter');
        var investmentStyleFilter = document.getElementById('investment-style-filter');
        var timeFilter = document.getElementById('time-filter');
        var industryFilter = document.getElementById('industry-filter');
        var searchBtn = document.getElementById('search-btn');
        
        function filterAll() {
            var filtered = [].concat(financialEvents);
            var ai = aiToolFilter.value;
            var ind = industryFilter.value;
            
            if (ai !== 'all') {
                filtered = filtered.filter(function(e) {
                    var tools = e.aiTools || ['doubao'];
                    return tools.includes(ai);
                });
            }
            
            if (ind !== 'all') {
                filtered = filtered.filter(function(e) {
                    return e.industry === ind;
                });
            }
            
            renderFinancialEvents(filtered);
        }
        
        if (searchBtn) searchBtn.onclick = filterAll;
        if (aiToolFilter) aiToolFilter.onchange = filterAll;
        if (industryFilter) industryFilter.onchange = filterAll;
        if (timeFilter) timeFilter.onchange = filterAll;
        if (investmentStyleFilter) investmentStyleFilter.onchange = filterAll;
    }

    /**
     * 初始化页面
     */
    function initPage() {
        // 1. 初始化图表
        var chartElement = document.getElementById('marketOverviewChart');
        if (chartElement && typeof Chart !== 'undefined') {
            var ctx = chartElement.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1月', '2月', '3月', '4月', '5月', '6月'],
                    datasets: [{
                        label: '市场指数',
                        data: [1200, 1350, 1280, 1420, 1500, 1580],
                        borderColor: 'white',
                        backgroundColor: 'rgba(255, 255, 255, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { color: 'white' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // 2. 初始化加载基础数据
        setTimeout(function() {
            financialEvents = getBasicFinancialEvents();
            investors = getBasicInvestors();
            renderFinancialEvents(financialEvents);
            renderInvestors(investors);
        }, 100);
        
        // 3. 设置筛选
        setupFilters();
        
        // 4. 绑定刷新按钮
        var debouncedRefresh = debounce(autoFetchDoubaoAnswer, config.debounceTime);
        
        const refreshBtn = document.getElementById('refresh-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', function() {
                console.log('手动刷新按钮点击');
                debouncedRefresh();
            });
        }
        
        const newsRefreshBtn = document.getElementById('news-refresh-btn');
        if (newsRefreshBtn) {
            newsRefreshBtn.addEventListener('click', function() {
                console.log('新闻刷新按钮点击');
                debouncedRefresh();
            });
        }
        
        const investorRefreshBtn = document.getElementById('investor-refresh-btn');
        if (investorRefreshBtn) {
            investorRefreshBtn.addEventListener('click', function() {
                console.log('大佬数据刷新按钮点击');
                debouncedRefresh();
            });
        }
        
        // 5. 绑定提问按钮
        const askBtn = document.getElementById('doubao-ask-btn');
        if (askBtn) {
            askBtn.addEventListener('click', function() {
                const questionInput = document.getElementById('doubao-question');
                const question = questionInput ? questionInput.value.trim() : '';
                if (question) {
                    askDoubao(question);
                } else {
                    alert('请输入提问内容！');
                }
            });
        }
        
        // 回车提问
        const questionInput = document.getElementById('doubao-question');
        if (questionInput) {
            questionInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    if (askBtn) askBtn.click();
                }
            });
        }
        
        // 更新时间
        updateLastUpdateTime();
    }

    // 页面加载初始化
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        initPage();
    } else {
        document.addEventListener('DOMContentLoaded', initPage);
    }
</script>
</body>
</html>
